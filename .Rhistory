# then what we actually do
lbl = f1laptimelm::CalculateFuelTyreEffect(lbl, 30)
SetUpModel()
CheckTeamYear = function(myTeam, myYear) {
myList = lbl %>%
filter(isGood30) %>%
group_by(race) %>%
do(FitFuelOnlyLm(., myTeam = myTeam, myYear = myYear))
fuelOnlyLmDF = bind_rows(myList)
lbl = left_join(lbl, fuelOnlyLmDF, c('race', 'driver', 'lap'))
myList = lbl %>%
filter(isGood30) %>%
group_by(race) %>%
do(FitFuelTyreLapOnlyLm(., myTeam = myTeam, myYear = myYear))
fuelTyreLapOnlyLmDF = bind_rows(myList)
lbl = left_join(lbl, fuelTyreLapOnlyLmDF, c('race', 'driver', 'lap'))
myList = lbl %>%
filter(isGood30) %>%
group_by(race) %>%
do(FitFuelTyreTypeOnlyLm(., myTeam = myTeam, myYear = myYear))
fuelTyreTypeOnlyLmDF = bind_rows(myList)
lbl = left_join(lbl, fuelTyreTypeOnlyLmDF, c('race', 'driver', 'lap'))
myList = lbl %>%
filter(isGood30) %>%
group_by(race) %>%
do(FitFuelTyreCommonSlopeLm(., myTeam = myTeam, myYear = myYear))
fuelTyreCommonSlopeLmDF = bind_rows(myList)
lbl = left_join(lbl, fuelTyreCommonSlopeLmDF, c('race', 'driver', 'lap'))
return(lbl)
}
lbl = lazy_left_join(lbl, rddf, c('race', 'driver'), 'team')
# then what we actually do
lbl = f1laptimelm::CalculateFuelTyreEffect(lbl, 30)
FitFuelOnlyLm = function(myLbl, myTeam, myYear) {
mod = lm(sec ~ factor(driver) + fuel,
data = myLbl %>% filter(!(team == myTeam & year == myYear)))
myLbl$fuelOnlyEffect = coef(mod)[['fuel']] * myLbl$fuel
return(myLbl %>%
select(race, driver, lap, fuelOnlyEffect))
}
#### then fuel plus
FitFuelTyreLapOnlyLm = function(myLbl, myTeam, myYear) {
mod = lm(sec ~ factor(driver) + fuel + tyreLap,
data = myLbl %>% filter(!(team == myTeam & year == myYear)))
myLbl$fuelTyreLapOnlyEffect = coef(mod)[['fuel']] * myLbl$fuel + coef(mod)[['tyreLap']] * myLbl$tyreLap
return(myLbl %>%
select(race, driver, lap, fuelTyreLapOnlyEffect))
}
FitFuelTyreTypeOnlyLm = function(myLbl, myTeam, myYear) {
mod = lm(sec ~ factor(driver) + fuel + factor(tyre),
data = myLbl %>% filter(!(team == myTeam & year == myYear)))
# what a hassle..
uglyTyreCoef = coef(mod)[grep('factor\\(tyre\\)', names(coef(mod)))]
neatTyreCoefDF = list_to_tibble(uglyTyreCoef, 'coef', 'tyre') %>%
mutate(tyre = gsub('factor\\(tyre\\)', '', tyre))
missingTyre = setdiff(unique(myLbl$tyre), neatTyreCoefDF$tyre)
neatTyreCoefDF = add_row(neatTyreCoefDF, tyre = missingTyre, coef = 0)
myLbl$tyreTypeEffect = neatTyreCoefDF$coef[match(myLbl$tyre, neatTyreCoefDF$tyre)]
myLbl$fuelTyreTypeOnlyEffect = coef(mod)[['fuel']] * myLbl$fuel + myLbl$tyreTypeEffect
return(myLbl %>%
select(race, driver, lap, fuelTyreTypeOnlyEffect))
}
### then, fuel and tyre age and type, but common slope for them
FitFuelTyreCommonSlopeLm = function(myLbl, myTeam, myYear) {
FitFuelTyreCommonSlopeLm = function(myLbl, myTeam, myYear) {
mod = lm(sec ~ factor(driver) + fuel + factor(tyre) + tyreLap,
data = myLbl %>% filter(!(team == myTeam & year == myYear))
# what a hassle..
uglyTyreCoef = coef(mod)[grep('factor\\(tyre\\)', names(coef(mod)))]
neatTyreCoefDF = list_to_tibble(uglyTyreCoef, 'coef', 'tyre') %>%
mutate(tyre = gsub('factor\\(tyre\\)', '', tyre))
missingTyre = setdiff(unique(myLbl$tyre), neatTyreCoefDF$tyre)
neatTyreCoefDF = add_row(neatTyreCoefDF, tyre = missingTyre, coef = 0)
myLbl$tyreTypeEffect = neatTyreCoefDF$coef[match(myLbl$tyre, neatTyreCoefDF$tyre)]
myLbl$fuelTyreCommonSlopeEffect = coef(mod)[['fuel']] * myLbl$fuel + myLbl$tyreTypeEffect + coef(mod)[['tyreLap']] * myLbl$tyreLap
return(myLbl %>%
select(race, driver, lap, fuelTyreCommonSlopeEffect))
}
myTeam = 'renault'
myYear = 2019
mod = lm(sec ~ factor(driver) + fuel + factor(tyre) + tyreLap,
data = myLbl %>% filter(!(team == myTeam & year == myYear))
# what a hassle..
uglyTyreCoef = coef(mod)[grep('factor\\(tyre\\)', names(coef(mod)))]
neatTyreCoefDF = list_to_tibble(uglyTyreCoef, 'coef', 'tyre') %>%
mutate(tyre = gsub('factor\\(tyre\\)', '', tyre))
missingTyre = setdiff(unique(myLbl$tyre), neatTyreCoefDF$tyre)
neatTyreCoefDF = add_row(neatTyreCoefDF, tyre = missingTyre, coef = 0)
myLbl$tyreTypeEffect = neatTyreCoefDF$coef[match(myLbl$tyre, neatTyreCoefDF$tyre)]
myLbl$fuelTyreCommonSlopeEffect = coef(mod)[['fuel']] * myLbl$fuel + myLbl$tyreTypeEffect + coef(mod)[['tyreLap']] * myLbl$tyreLap
return(myLbl %>%
select(race, driver, lap, fuelTyreCommonSlopeEffect))
}
# these names are a little confusing to be fair
# but they're not fitted out of sample so isn't the most complicated bound to win? not sure
# so, first model assume all team mates are equally good, predict lap time difference.
# we're only predicting a subset of the data, so maybe it's not guaranteed to be better for a small sample?
# no i think it's still guaranteed to be better once we've aggregated over all pairings.
# but we could loop over all team-seasons, eliminate that team's data, then refit the models above. that is a great idea in fact
CheckTeamYear = function(myTeam, myYear) {
myList = lbl %>%
filter(isGood30) %>%
group_by(race) %>%
do(FitFuelOnlyLm(., myTeam = myTeam, myYear = myYear))
fuelOnlyLmDF = bind_rows(myList)
lbl = left_join(lbl, fuelOnlyLmDF, c('race', 'driver', 'lap'))
myList = lbl %>%
filter(isGood30) %>%
group_by(race) %>%
do(FitFuelTyreLapOnlyLm(., myTeam = myTeam, myYear = myYear))
fuelTyreLapOnlyLmDF = bind_rows(myList)
lbl = left_join(lbl, fuelTyreLapOnlyLmDF, c('race', 'driver', 'lap'))
myList = lbl %>%
filter(isGood30) %>%
group_by(race) %>%
do(FitFuelTyreTypeOnlyLm(., myTeam = myTeam, myYear = myYear))
fuelTyreTypeOnlyLmDF = bind_rows(myList)
lbl = left_join(lbl, fuelTyreTypeOnlyLmDF, c('race', 'driver', 'lap'))
myList = lbl %>%
filter(isGood30) %>%
group_by(race) %>%
do(FitFuelTyreCommonSlopeLm(., myTeam = myTeam, myYear = myYear))
fuelTyreCommonSlopeLmDF = bind_rows(myList)
lbl = left_join(lbl, fuelTyreCommonSlopeLmDF, c('race', 'driver', 'lap'))
return(lbl)
}
mod = lm(sec ~ factor(driver) + fuel + factor(tyre) + tyreLap,
data = myLbl %>% filter(!(team == myTeam & year == myYear))
# what a hassle..
uglyTyreCoef = coef(mod)[grep('factor\\(tyre\\)', names(coef(mod)))]
neatTyreCoefDF = list_to_tibble(uglyTyreCoef, 'coef', 'tyre') %>%
mutate(tyre = gsub('factor\\(tyre\\)', '', tyre))
missingTyre = setdiff(unique(myLbl$tyre), neatTyreCoefDF$tyre)
neatTyreCoefDF = add_row(neatTyreCoefDF, tyre = missingTyre, coef = 0)
myLbl$tyreTypeEffect = neatTyreCoefDF$coef[match(myLbl$tyre, neatTyreCoefDF$tyre)]
myLbl$fuelTyreCommonSlopeEffect = coef(mod)[['fuel']] * myLbl$fuel + myLbl$tyreTypeEffect + coef(mod)[['tyreLap']] * myLbl$tyreLap
return(myLbl %>%
select(race, driver, lap, fuelTyreCommonSlopeEffect))
}
# these names are a little confusing to be fair
# but they're not fitted out of sample so isn't the most complicated bound to win? not sure
# so, first model assume all team mates are equally good, predict lap time difference.
# we're only predicting a subset of the data, so maybe it's not guaranteed to be better for a small sample?
# no i think it's still guaranteed to be better once we've aggregated over all pairings.
# but we could loop over all team-seasons, eliminate that team's data, then refit the models above. that is a great idea in fact
CheckTeamYear = function(myTeam, myYear) {
myList = lbl %>%
filter(isGood30) %>%
group_by(race) %>%
do(FitFuelOnlyLm(., myTeam = myTeam, myYear = myYear))
fuelOnlyLmDF = bind_rows(myList)
lbl = left_join(lbl, fuelOnlyLmDF, c('race', 'driver', 'lap'))
myList = lbl %>%
filter(isGood30) %>%
group_by(race) %>%
do(FitFuelTyreLapOnlyLm(., myTeam = myTeam, myYear = myYear))
fuelTyreLapOnlyLmDF = bind_rows(myList)
lbl = left_join(lbl, fuelTyreLapOnlyLmDF, c('race', 'driver', 'lap'))
myList = lbl %>%
filter(isGood30) %>%
group_by(race) %>%
do(FitFuelTyreTypeOnlyLm(., myTeam = myTeam, myYear = myYear))
fuelTyreTypeOnlyLmDF = bind_rows(myList)
lbl = left_join(lbl, fuelTyreTypeOnlyLmDF, c('race', 'driver', 'lap'))
myList = lbl %>%
filter(isGood30) %>%
group_by(race) %>%
do(FitFuelTyreCommonSlopeLm(., myTeam = myTeam, myYear = myYear))
fuelTyreCommonSlopeLmDF = bind_rows(myList)
lbl = left_join(lbl, fuelTyreCommonSlopeLmDF, c('race', 'driver', 'lap'))
return(lbl)
}
FitFuelTyreCommonSlopeLm = function(myLbl, myTeam, myYear) {
mod = lm(sec ~ factor(driver) + fuel + factor(tyre) + tyreLap,
data = myLbl %>% filter(!(team == myTeam & year == myYear)))
# what a hassle..
uglyTyreCoef = coef(mod)[grep('factor\\(tyre\\)', names(coef(mod)))]
neatTyreCoefDF = list_to_tibble(uglyTyreCoef, 'coef', 'tyre') %>%
mutate(tyre = gsub('factor\\(tyre\\)', '', tyre))
missingTyre = setdiff(unique(myLbl$tyre), neatTyreCoefDF$tyre)
neatTyreCoefDF = add_row(neatTyreCoefDF, tyre = missingTyre, coef = 0)
myLbl$tyreTypeEffect = neatTyreCoefDF$coef[match(myLbl$tyre, neatTyreCoefDF$tyre)]
myLbl$fuelTyreCommonSlopeEffect = coef(mod)[['fuel']] * myLbl$fuel + myLbl$tyreTypeEffect + coef(mod)[['tyreLap']] * myLbl$tyreLap
return(myLbl %>%
select(race, driver, lap, fuelTyreCommonSlopeEffect))
}
CheckTeamYear = function(myTeam, myYear) {
myList = lbl %>%
filter(isGood30) %>%
group_by(race) %>%
do(FitFuelOnlyLm(., myTeam = myTeam, myYear = myYear))
fuelOnlyLmDF = bind_rows(myList)
lbl = left_join(lbl, fuelOnlyLmDF, c('race', 'driver', 'lap'))
myList = lbl %>%
filter(isGood30) %>%
group_by(race) %>%
do(FitFuelTyreLapOnlyLm(., myTeam = myTeam, myYear = myYear))
fuelTyreLapOnlyLmDF = bind_rows(myList)
lbl = left_join(lbl, fuelTyreLapOnlyLmDF, c('race', 'driver', 'lap'))
myList = lbl %>%
filter(isGood30) %>%
group_by(race) %>%
do(FitFuelTyreTypeOnlyLm(., myTeam = myTeam, myYear = myYear))
fuelTyreTypeOnlyLmDF = bind_rows(myList)
lbl = left_join(lbl, fuelTyreTypeOnlyLmDF, c('race', 'driver', 'lap'))
myList = lbl %>%
filter(isGood30) %>%
group_by(race) %>%
do(FitFuelTyreCommonSlopeLm(., myTeam = myTeam, myYear = myYear))
fuelTyreCommonSlopeLmDF = bind_rows(myList)
lbl = left_join(lbl, fuelTyreCommonSlopeLmDF, c('race', 'driver', 'lap'))
return(lbl)
}
dum = CheckTeamYear('renault', 2019)
names(dum)
myDriv1 = 'dricciardo'
myDriv2 = 'nhulkenberg'
# now we make the data frame with relevant comparisons
myLbl = lbl %>%
filter(driver %in% c(myDriv1, myDriv2) & year == myYear & !isRogue)
myLbl = f1laptimelm::CalculateFuelTyreEffect(myLbl, 30)
colToSpread = c('sec', 'inTraffic', 'isCarProblem', 'modalFinPosProb',
'fuelOnlyEffect', 'fuelTyreLapOnlyEffect',
'fuelTyreTypeOnlyEffect', 'fuelTyreCommonSlopeEffect')
horizLbl = myLbl %>%
select(race, lap, driver, colToSpread) %>%
spread_multiple(keyCol = driver, sec, inTraffic, isCarProblem, modalFinPosProb,
fuelOnlyEffect, fuelTyreLapOnlyEffect,
fuelTyreTypeOnlyEffect, fuelTyreCommonSlopeEffect)
names(myLbl)
SetUpModel()
lbl = lazy_left_join(lbl, rddf, c('race', 'driver'), 'team')
SetUpModel()
SingleRaceFitFuelOnlyLm = function(myLbl) {
mod = lm(sec ~ factor(driver) + fuel, data = myLbl)
myLbl$fuelOnlyEffect = coef(mod)[['fuel']] * myLbl$fuel
return(myLbl %>%
select(race, driver, lap, fuelOnlyEffect))
}
FitFuelOnlyLm = function(lbl, myDriv1, myDriv2, myYear) {
myList = lbl %>%
filter(isGood30 & !(driver %in% c('driv1, driv2') & year == myYear)) %>%
group_by(race) %>%
do(SingleRaceFitFuelOnlyLm(.ar))
fuelOnlyLmDF = bind_rows(myList)
lbl = left_join(lbl, fuelOnlyLmDF, c('race', 'driver', 'lap'))
return(lbl)
}
lbl = FitFuelOnlyLm(lbl, 'dricciardo', 'nhulkenberg', 2019)
FitFuelOnlyLm = function(lbl, myDriv1, myDriv2, myYear) {
myList = lbl %>%
filter(isGood30 & !(driver %in% c('driv1, driv2') & year == myYear)) %>%
group_by(race) %>%
do(SingleRaceFitFuelOnlyLm(.))
fuelOnlyLmDF = bind_rows(myList)
lbl = left_join(lbl, fuelOnlyLmDF, c('race', 'driver', 'lap'))
return(lbl)
}
lbl = FitFuelOnlyLm(lbl, 'dricciardo', 'nhulkenberg', 2019)
lbl2 = FitFuelOnlyLm(lbl, 'aalbon', 'dkvyat', 2019)
lbl2 %>% filter(race == '2019australia' & driver == 'dkvyat') %>% select(fuelOnlyEffect)
SetUpModel()
lbl = FitFuelOnlyLm(lbl, 'dricciardo', 'nhulkenberg', 2019)
names(lbl)
lbl2 = FitFuelOnlyLm(lbl, 'lstroll', 'sperez', 2019)
lbl2 %>% filter(race == '2019australia' & driver == 'dkvyat') %>% select(fuelOnlyEffect)
lbl2 %>% filter(race == '2019australia' & driver == 'dkvyat') %>% select(fuelOnlyEffect.x, fuelOnlyEffect.y)
lbl2 %>% filter(race == '2019australia' & driver == 'sperez') %>% select(fuelOnlyEffect.x, fuelOnlyEffect.y)
all.equal(lbl2$fuelOnlyEffect.x, lbl2$fuelOnlyEffect.y)
lbl = within(lbl, rm(fuelOnlyEffect))
SingleRaceFitFuelOnlyLm = function(myLbl) {
mod = lm(sec ~ factor(driver) + fuel, data = myLbl)
myLbl$fuelOnlyEffect = coef(mod)[['fuel']] * myLbl$fuel
return(myLbl %>%
select(race, driver, lap, fuelOnlyEffect))
}
FitFuelOnlyLm = function(lbl, myDriv1, myDriv2, myYear) {
myList = lbl %>%
filter(isGood30 & !(driver %in% c(myDriv1, myDriv2) & year == myYear)) %>%
group_by(race) %>%
do(SingleRaceFitFuelOnlyLm(.))
fuelOnlyLmDF = bind_rows(myList)
lbl = left_join(lbl, fuelOnlyLmDF, c('race', 'driver', 'lap'))
return(lbl)
}
lbl = FitFuelOnlyLm(lbl, 'dricciardo', 'nhulkenberg', 2019)
lbl = FitFuelOnlyLm(lbl, 'lstroll', 'sperez', 2019)
all.equal(lbl$fuelOnlyEffect.x, lbl$fuelOnlyEffect.y)
lbl2 %>% filter(race == '2019australia' & driver == 'sperez') %>% select(fuelOnlyEffect.x, fuelOnlyEffect.y)
lbl %>% filter(race == '2019australia' & driver == 'sperez') %>% select(fuelOnlyEffect.x, fuelOnlyEffect.y)
SetUpModel()
SingleRaceFitFuelOnlyLm = function(myLbl, myDriv1, myDriv2, myYear) {
mod = lm(sec ~ factor(driver) + fuel,
data = myLbl %>% filter(!(driver %in% c(myDriv1, myDriv2) & year == myYear)))
myLbl$fuelOnlyEffect = coef(mod)[['fuel']] * myLbl$fuel
return(myLbl %>%
select(race, driver, lap, fuelOnlyEffect))
}
FitFuelOnlyLm = function(lbl, myDriv1, myDriv2, myYear) {
myList = lbl %>%
filter(isGood30) %>%
group_by(race) %>%
do(SingleRaceFitFuelOnlyLm(., myDriv1 = myDriv1, myDriv2 = myDriv2, myYear = myYear))
fuelOnlyLmDF = bind_rows(myList)
lbl = left_join(lbl, fuelOnlyLmDF, c('race', 'driver', 'lap'))
return(lbl)
}
lbl2 = FitFuelOnlyLm(lbl, 'sperez', 'lstroll')
lbl2 = FitFuelOnlyLm(lbl, 'sperez', 'lstroll', 2019)
lbl2 = FitFuelOnlyLm(lbl2, 'dricciardo', 'nhulkenberg', 2019)
lbl %>% filter(race == '2019australia' & driver == 'sperez') %>% select(fuelOnlyEffect.x, fuelOnlyEffect.y)
lbl2 %>% filter(race == '2019australia' & driver == 'sperez') %>% select(fuelOnlyEffect.x, fuelOnlyEffect.y)
lbl2 %>% filter(race == '2019australia' & driver == 'sperez') %>% select(isGood30, fuelOnlyEffect.x, fuelOnlyEffect.y)
SetUpModel()
source('f1-startup.r')
SetUpModel()
SingleRaceFitFuelOnlyLm = function(myLbl, myDriv1, myDriv2, myYear) {
mod = lm(sec ~ factor(driver) + fuel,
data = myLbl %>% filter(!(driver %in% c(myDriv1, myDriv2) & year == myYear)))
myLbl$fuelOnlyEffect = coef(mod)[['fuel']] * myLbl$fuel
return(myLbl %>%
select(race, driver, lap, fuelOnlyEffect))
}
#### then fuel plus tyre age, ignore compound
SingleRaceFitFuelTyreLapOnlyLm = function(myLbl, myTeam, myYear) {
mod = lm(sec ~ factor(driver) + fuel + tyreLap,
data = myLbl %>% filter(!(team == myTeam & year == myYear)))
myLbl$fuelTyreLapOnlyEffect = coef(mod)[['fuel']] * myLbl$fuel + coef(mod)[['tyreLap']] * myLbl$tyreLap
return(myLbl %>%
select(race, driver, lap, fuelTyreLapOnlyEffect))
}
## now fuel and tyre compound but not tyre age
SingleRaceFitFuelTyreTypeOnlyLm = function(myLbl, myTeam, myYear) {
mod = lm(sec ~ factor(driver) + fuel + factor(tyre),
data = myLbl %>% filter(!(team == myTeam & year == myYear)))
# what a hassle..
uglyTyreCoef = coef(mod)[grep('factor\\(tyre\\)', names(coef(mod)))]
neatTyreCoefDF = list_to_tibble(uglyTyreCoef, 'coef', 'tyre') %>%
mutate(tyre = gsub('factor\\(tyre\\)', '', tyre))
missingTyre = setdiff(unique(myLbl$tyre), neatTyreCoefDF$tyre)
neatTyreCoefDF = add_row(neatTyreCoefDF, tyre = missingTyre, coef = 0)
myLbl$tyreTypeEffect = neatTyreCoefDF$coef[match(myLbl$tyre, neatTyreCoefDF$tyre)]
myLbl$fuelTyreTypeOnlyEffect = coef(mod)[['fuel']] * myLbl$fuel + myLbl$tyreTypeEffect
return(myLbl %>%
select(race, driver, lap, fuelTyreTypeOnlyEffect))
}
### then, fuel and tyre age and type, but common slope for them
SingleRaceFitFuelTyreCommonSlopeLm = function(myLbl, myTeam, myYear) {
mod = lm(sec ~ factor(driver) + fuel + factor(tyre) + tyreLap,
data = myLbl %>% filter(!(team == myTeam & year == myYear)))
# what a hassle..
uglyTyreCoef = coef(mod)[grep('factor\\(tyre\\)', names(coef(mod)))]
neatTyreCoefDF = list_to_tibble(uglyTyreCoef, 'coef', 'tyre') %>%
mutate(tyre = gsub('factor\\(tyre\\)', '', tyre))
missingTyre = setdiff(unique(myLbl$tyre), neatTyreCoefDF$tyre)
neatTyreCoefDF = add_row(neatTyreCoefDF, tyre = missingTyre, coef = 0)
myLbl$tyreTypeEffect = neatTyreCoefDF$coef[match(myLbl$tyre, neatTyreCoefDF$tyre)]
myLbl$fuelTyreCommonSlopeEffect = coef(mod)[['fuel']] * myLbl$fuel + myLbl$tyreTypeEffect + coef(mod)[['tyreLap']] * myLbl$tyreLap
return(myLbl %>%
select(race, driver, lap, fuelTyreCommonSlopeEffect))
}
FitAllLm = function(lbl, myDriv1, myDriv2, myYear) {
myList = lbl %>%
filter(isGood30) %>%
group_by(race) %>%
do(SingleRaceFitFuelOnlyLm(., myDriv1 = myDriv1, myDriv2 = myDriv2, myYear = myYear))
fuelOnlyLmDF = bind_rows(myList)
myList = lbl %>%
filter(isGood30) %>%
group_by(race) %>%
do(SingleRaceFitFuelTyreLapOnlyLm(., myTeam = myTeam, myYear = myYear))
fuelTyreLapOnlyLmDF = bind_rows(myList)
myList = lbl %>%
filter(isGood30) %>%
group_by(race) %>%
do(SingleRaceFitFuelTyreTypeOnlyLm(., myTeam = myTeam, myYear = myYear))
fuelTyreTypeOnlyLmDF = bind_rows(myList)
myList = lbl %>%
filter(isGood30) %>%
group_by(race) %>%
do(SingleRaceFitFuelTyreCommonSlopeLm(., myTeam = myTeam, myYear = myYear))
fuelTyreCommonSlopeLmDF = bind_rows(myList)
lbl = left_join(lbl, fuelOnlyLmDF, c('race', 'driver', 'lap'))
lbl = left_join(lbl, fuelTyreLapOnlyLmDF, c('race', 'driver', 'lap'))
lbl = left_join(lbl, fuelTyreTypeOnlyLmDF, c('race', 'driver', 'lap'))
lbl = left_join(lbl, fuelTyreCommonSlopeLmDF, c('race', 'driver', 'lap'))
return(lbl)
}
myDriv1 = 'dricciardo'
myDriv2 = 'nhulkenberg'
myYear = 2019
lbl = FitAllLm(lbl, myDriv1, myDriv2, myYear)
SingleRaceFitFuelOnlyLm = function(myLbl, myDriv1, myDriv2, myYear) {
mod = lm(sec ~ factor(driver) + fuel,
data = myLbl %>% filter(!(driver %in% c(myDriv1, myDriv2) & year == myYear)))
myLbl$fuelOnlyEffect = coef(mod)[['fuel']] * myLbl$fuel
return(myLbl %>%
select(race, driver, lap, fuelOnlyEffect))
}
#### then fuel plus tyre age, ignore compound
SingleRaceFitFuelTyreLapOnlyLm = function(myLbl, myDriv1, myDriv2, myYear) {
mod = lm(sec ~ factor(driver) + fuel + tyreLap,
data = myLbl %>% filter(!(driver %in% c(myDriv1, myDriv2) & year == myYear)))
myLbl$fuelTyreLapOnlyEffect = coef(mod)[['fuel']] * myLbl$fuel + coef(mod)[['tyreLap']] * myLbl$tyreLap
return(myLbl %>%
select(race, driver, lap, fuelTyreLapOnlyEffect))
}
## now fuel and tyre compound but not tyre age
SingleRaceFitFuelTyreTypeOnlyLm = function(myLbl, myDriv1, myDriv2, myYear) {
mod = lm(sec ~ factor(driver) + fuel + factor(tyre),
data = myLbl %>% filter(!(driver %in% c(myDriv1, myDriv2) & year == myYear)))
# what a hassle..
uglyTyreCoef = coef(mod)[grep('factor\\(tyre\\)', names(coef(mod)))]
neatTyreCoefDF = list_to_tibble(uglyTyreCoef, 'coef', 'tyre') %>%
mutate(tyre = gsub('factor\\(tyre\\)', '', tyre))
missingTyre = setdiff(unique(myLbl$tyre), neatTyreCoefDF$tyre)
neatTyreCoefDF = add_row(neatTyreCoefDF, tyre = missingTyre, coef = 0)
myLbl$tyreTypeEffect = neatTyreCoefDF$coef[match(myLbl$tyre, neatTyreCoefDF$tyre)]
myLbl$fuelTyreTypeOnlyEffect = coef(mod)[['fuel']] * myLbl$fuel + myLbl$tyreTypeEffect
return(myLbl %>%
select(race, driver, lap, fuelTyreTypeOnlyEffect))
}
### then, fuel and tyre age and type, but common slope for them
SingleRaceFitFuelTyreCommonSlopeLm = function(myLbl, myDriv1, myDriv2, myYear) {
mod = lm(sec ~ factor(driver) + fuel + factor(tyre) + tyreLap,
data = myLbl %>% filter(!(driver %in% c(myDriv1, myDriv2) & year == myYear)))
# what a hassle..
uglyTyreCoef = coef(mod)[grep('factor\\(tyre\\)', names(coef(mod)))]
neatTyreCoefDF = list_to_tibble(uglyTyreCoef, 'coef', 'tyre') %>%
mutate(tyre = gsub('factor\\(tyre\\)', '', tyre))
missingTyre = setdiff(unique(myLbl$tyre), neatTyreCoefDF$tyre)
neatTyreCoefDF = add_row(neatTyreCoefDF, tyre = missingTyre, coef = 0)
myLbl$tyreTypeEffect = neatTyreCoefDF$coef[match(myLbl$tyre, neatTyreCoefDF$tyre)]
myLbl$fuelTyreCommonSlopeEffect = coef(mod)[['fuel']] * myLbl$fuel + myLbl$tyreTypeEffect + coef(mod)[['tyreLap']] * myLbl$tyreLap
return(myLbl %>%
select(race, driver, lap, fuelTyreCommonSlopeEffect))
}
FitAllLm = function(lbl, myDriv1, myDriv2, myYear) {
myList = lbl %>%
filter(isGood30) %>%
group_by(race) %>%
do(SingleRaceFitFuelOnlyLm(., myDriv1 = myDriv1, myDriv2 = myDriv2, myYear = myYear))
fuelOnlyLmDF = bind_rows(myList)
myList = lbl %>%
filter(isGood30) %>%
group_by(race) %>%
do(SingleRaceFitFuelTyreLapOnlyLm(., myTeam = myTeam, myYear = myYear))
fuelTyreLapOnlyLmDF = bind_rows(myList)
myList = lbl %>%
filter(isGood30) %>%
group_by(race) %>%
do(SingleRaceFitFuelTyreTypeOnlyLm(., myTeam = myTeam, myYear = myYear))
fuelTyreTypeOnlyLmDF = bind_rows(myList)
myList = lbl %>%
filter(isGood30) %>%
group_by(race) %>%
do(SingleRaceFitFuelTyreCommonSlopeLm(., myTeam = myTeam, myYear = myYear))
fuelTyreCommonSlopeLmDF = bind_rows(myList)
lbl = left_join(lbl, fuelOnlyLmDF, c('race', 'driver', 'lap'))
lbl = left_join(lbl, fuelTyreLapOnlyLmDF, c('race', 'driver', 'lap'))
lbl = left_join(lbl, fuelTyreTypeOnlyLmDF, c('race', 'driver', 'lap'))
lbl = left_join(lbl, fuelTyreCommonSlopeLmDF, c('race', 'driver', 'lap'))
return(lbl)
}
lbl = FitAllLm(lbl, myDriv1, myDriv2, myYear)
FitAllLm = function(lbl, myDriv1, myDriv2, myYear) {
myList = lbl %>%
filter(isGood30) %>%
group_by(race) %>%
do(SingleRaceFitFuelOnlyLm(., myDriv1 = myDriv1, myDriv2 = myDriv2, myYear = myYear))
fuelOnlyLmDF = bind_rows(myList)
myList = lbl %>%
filter(isGood30) %>%
group_by(race) %>%
do(SingleRaceFitFuelTyreLapOnlyLm(., myDriv1 = myDriv1, myDriv2 = myDriv2, myYear = myYear))
fuelTyreLapOnlyLmDF = bind_rows(myList)
myList = lbl %>%
filter(isGood30) %>%
group_by(race) %>%
do(SingleRaceFitFuelTyreTypeOnlyLm(., myDriv1 = myDriv1, myDriv2 = myDriv2, myYear = myYear))
fuelTyreTypeOnlyLmDF = bind_rows(myList)
myList = lbl %>%
filter(isGood30) %>%
group_by(race) %>%
do(SingleRaceFitFuelTyreCommonSlopeLm(., myDriv1 = myDriv1, myDriv2 = myDriv2, myYear = myYear))
fuelTyreCommonSlopeLmDF = bind_rows(myList)
lbl = left_join(lbl, fuelOnlyLmDF, c('race', 'driver', 'lap'))
lbl = left_join(lbl, fuelTyreLapOnlyLmDF, c('race', 'driver', 'lap'))
lbl = left_join(lbl, fuelTyreTypeOnlyLmDF, c('race', 'driver', 'lap'))
lbl = left_join(lbl, fuelTyreCommonSlopeLmDF, c('race', 'driver', 'lap'))
return(lbl)
}
lbl = FitAllLm(lbl, myDriv1, myDriv2, myYear)
names(lbl)
# now we make the data frame with relevant comparisons
myLbl = lbl %>%
filter(driver %in% c(myDriv1, myDriv2) & year == myYear & !isRogue)
colToSpread = c('sec', 'inTraffic', 'isCarProblem', 'modalFinPosProb',
'fuelOnlyEffect', 'fuelTyreLapOnlyEffect',
'fuelTyreTypeOnlyEffect', 'fuelTyreCommonSlopeEffect')
horizLbl = myLbl %>%
select(race, lap, driver, colToSpread) %>%
spread_multiple(keyCol = driver, sec, inTraffic, isCarProblem, modalFinPosProb,
fuelOnlyEffect, fuelTyreLapOnlyEffect,
fuelTyreTypeOnlyEffect, fuelTyreCommonSlopeEffect)
## horrible names of course, so rename
badName = paste0('driver', apply(expand.grid(c(myDriv1, myDriv2), colToSpread), 1, paste, collapse = '_'))
goodName = apply(expand.grid(c(1, 2), colToSpread), 1, function(x) paste(rev(x), collapse = ''))
for (j in 1:length(badName)) {
names(horizLbl)[names(horizLbl) == badName[j]] = goodName[j]
}
horizLbl[1,]
